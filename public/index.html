<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Statmeat - put the meat to the beat</title>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="container-fluid">
      <div class="row-fluid">
	<h1>Statmeat - meat to the beat</h1>
	<div class="input-group">
	  <span class="input-group-addon glyphicon glyphicon-search" aria-hidden="true"></span>
	  <input type="text" name="search" placeholder="Hae jengi채" class="form-control"></input>
	</div>
	<div class="checkbox">
	  <label>
	    <input type="checkbox" name="past" />
	    N채yt채 menneet
	  </label>
	</div>
      </div>

      <div class="row-fluid">
	<table class="matches table table-striped">
	  <thead>
	    <tr>
	      <th>Alkaa</th>
	      <th>Koti</th>
	      <th></th>
	      <th></th>
	      <th>Vieras</th>
	      <th title="Koti">K</th>
	      <th title="Vieras">V</th>
	      <th>Kentt채</th>
	    </tr>
	  </thead>
	  <tbody>
	  </tbody>
	</table>
      </div>
    </div>
  </body>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.15.1/moment.min.js"></script>
  <script src="nedb.min.js"></script>
  <script src="data.json"></script>
    <script>
    /* */

navigator.sayswho= (function(){
    var ua= navigator.userAgent, tem, 
    M= ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
    if(/trident/i.test(M[1])){
        tem=  /\brv[ :]+(\d+)/g.exec(ua) || [];
        return 'IE '+(tem[1] || '');
    }
    if(M[1]=== 'Chrome'){
        tem= ua.match(/\b(OPR|Edge)\/(\d+)/);
        if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera');
    }
    M= M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];
    if((tem= ua.match(/version\/(\d+)/i))!= null) M.splice(1, 1, tem[1]);
    return M.join(' ');
})();

var db = new Nedb();
var nowDate = new Date();
var fewDaysAgo = new Date();
fewDaysAgo.setDate(fewDaysAgo.getDate() - 2);
var fewDaysAgoString = moment(fewDaysAgo).format('YYYY-MM-DD HH:mm:ss');
var fewDaysAgoFilter = {
    'start_time': { '$gt': fewDaysAgoString }
};

var i = 0;
data.forEach(function(item) {
    if (navigator.sayswho.indexOf('Firefox') >= 0 && i > 450) {
	return;
    }
    db.insert(item);
    i++;
});

$(document).ready(function() {
    var showPast = $('input[name="past"]').is(':checked');
    var needle = window.location.hash.replace('#', '');

    $('input[name="search"]').val(needle);

    search(needle, showPast ? {} : fewDaysAgoFilter);
});

var searchFunc = () => {
    var needle = $('input[name="search"]').val();
    var showPast = $('input[name="past"]').is(':checked');
    
    window.history.replaceState({}, needle, '#' + needle);
    search(needle, showPast ? {} : fewDaysAgoFilter);
};

$('input[name="past"]').on('change', searchFunc);
$('input[name="search"]').on('keyup', searchFunc);

function search(needle, filter) {
    var re = new RegExp(needle, 'i');
    var query = {};
    query.name = re;
    Object.assign(query, filter);

    db.find(query).sort({'start_time': 1})
	.exec(function(err, docs) {
	    updateTable(docs);
    });
}

function updateTable(docs) {
    $('.matches tbody').empty()
    $('.matches').addClass('loader')

    docs.forEach(function(item) {
	var match = item;
	var classes = ((new Date(match.start_time)) < nowDate) ? 'past' : '';
	var homeTeam = match.home_team.attributes;
	var awayTeam = match.away_team.attributes;
	var homeTeamImg = '<img src="' + homeTeam.picture.small + '" />';
	var awayTeamImg = '<img src="' + awayTeam.picture.small + '" />';

	$('.matches tbody').append('<tr class="' + classes + '">'
				  + '<td>' + moment(match.start_time).format('YYYY-MM-DD HH:mm:ss') + '</td>'
				  + '<td title="' + homeTeam.hometown + '">' + homeTeam.name + '</td>'
				  + '<td>' + homeTeamImg + '</td>'
				  + '<td>' + awayTeamImg + '</td>'
				  + '<td title="' + awayTeam.hometown + '">' + awayTeam.name + '</td>'
				  + '<td>' + (match.home_points || '-') + '</td>'
				  + '<td>' + (match.away_points || '-') + '</td>'
				  + '<td>' + (match.pitch || '-') + '</td>'
				  + '</tr>'
				 );
    });

    $('.matches').removeClass('loader')
}



</script>
</html>
